@page "/deleteconfirmation"
@layout MainLayout
@inject UserService UserService
@inject UserSessionService UserSession
@inject NavigationManager Navigation

<!-- MOBILE VIEW (XS, SM) -->
<MudHidden Breakpoint="Breakpoint.MdAndUp">
    <MudStack Spacing="8" AlignItems="AlignItems.Center" Style="width: 100%">
        <img src="images/logo.png"
             alt="SparkCheck logo"
             style="width: 100%;" />

        <MudText Typo="Typo.body1" Align="Align.Center" Class="spark-text">
            We'll miss you, @UserSession.strUsername.
        </MudText>

        <MudText Typo="Typo.caption" Align="Align.Center" Class="spark-text">
            Your account has been deleted.
        </MudText>

        <MudText Typo="Typo.caption" Align="Align.Center" Class="spark-text">
            Redirecting in @_secondsLeft seconds...
        </MudText>

        <MudProgressCircular Indeterminate="true" Size="Size.Medium" />

        <MudText Typo="Typo.caption" Align="Align.Center" Class="spark-text">
            © 2025 SparkCheck | Cortanix
        </MudText>
    </MudStack>
</MudHidden>

<!-- DESKTOP/TABLET VIEW (MD and up) -->
<MudHidden Breakpoint="Breakpoint.SmAndDown">
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudStack Spacing="8" AlignItems="AlignItems.Center">
            <img src="images/logo.png" alt="SparkCheck logo" style="width: 70%;" />

            <MudText Typo="Typo.h6" Align="Align.Center" Class="spark-text">
                SparkCheck is optimized for mobile devices.
            </MudText>

            <MudText Typo="Typo.body1" Align="Align.Center" Class="spark-text">
                For the best experience, please open SparkCheck on your phone and save it to your home screen.
            </MudText>

            <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="spark-text">
                © 2025 SparkCheck | Cortanix
            </MudText>
        </MudStack>
    </MudContainer>
</MudHidden>

@code {
    private int _secondsLeft = 3;
    private System.Timers.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"[ACCOUNT DELETE] Deactivating account for UserID: {UserSession.intUserID}, Phone: {UserSession.strPhone}");

        bool success = await UserService.DeactivateUserAccountAsync(UserSession.intUserID!.Value, UserSession.strPhone!);

        if (success)
            Console.WriteLine("[ACCOUNT DELETE] Account marked inactive.");
        else
            Console.WriteLine("[ACCOUNT DELETE ERROR] Failed to mark account inactive.");

        // Clear session immediately
        UserSession.Clear();

        // Start countdown timer
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += async (_, _) =>
        {
            _secondsLeft--;
            if (_secondsLeft <= 0)
            {
                _timer.Dispose();
                await InvokeAsync(() => Navigation.NavigateTo("/"));
            }
            await InvokeAsync(StateHasChanged);
        };
        _timer.Start();
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
