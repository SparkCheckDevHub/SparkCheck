@page "/phonelogin"
@using SparkCheck.Services
@using SparkCheck.Models
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@layout MainLayout
@inject NavigationManager Navigation
@inject UserService UserService
@inject UserSessionService UserSession

<MudPaper Style="min-height: 100vh; padding: 1rem; display: flex; flex-direction: column; justify-content: center;">
    <EditForm Model="_loginModel" OnValidSubmit="HandleLogin">
        <DataAnnotationsValidator />

        <MudStack AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
            <MudText Typo="Typo.h5">Log In with Your Phone Number</MudText>

            @if (!string.IsNullOrWhiteSpace(ErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
                    @ErrorMessage
                </MudAlert>
            }
        </MudStack>

        <MudTextField Label="Phone Number" @bind-Value="_loginModel.strPhone" Required="true" Class="mb-2" />

        <MudGrid Class="mt-4">
            <MudItem xs="6">
                <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.ArrowBack" FullWidth="true"
                    OnClick="Cancel">
                    Cancel
                </MudButton>
            </MudItem>

            <MudItem xs="6">
                <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Login"
                    ButtonType="ButtonType.Submit" FullWidth="true">
                    Log In
                </MudButton>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudPaper>

@code {
    private LoginModel _loginModel = new();
    private string? ErrorMessage;

    private async Task HandleLogin()
    {
        ErrorMessage = null;

        var result = await UserService.AttemptLoginAsync(_loginModel.strPhone);

        if (result.blnSuccess && result.User is not null)
        {
            UserSession.intUserID = result.User.intUserID;
            UserSession.strPhone = result.User.strPhone;
            UserSession.strUsername = result.User.strUsername;
            UserSession.strFirstName = result.User.strFirstName;
            UserSession.strLastName = result.User.strLastName;
            UserSession.dtmDateOfBirth = result.User.dtmDateOfBirth;
            UserSession.intGenderID = result.User.intGenderID;
            UserSession.intZipCodeID = result.User.intZipCodeID;
            UserSession.blnIsActive = result.User.blnIsActive;
            UserSession.blnIsOnline = result.User.blnIsOnline;
            UserSession.blnInQueue = result.User.blnInQueue;
            UserSession.dtmQueuedDate = result.User.dtmQueuedDate;

            Navigation.NavigateTo("/phoneauth");
        }
        else
        {
            ErrorMessage = result.strErrorMessage ?? "Login failed. Try again.";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/welcome");
    }
}
